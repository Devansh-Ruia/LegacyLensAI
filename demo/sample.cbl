IDENTIFICATION DIVISION.
       PROGRAM-ID. LOAN-CALCULATOR.
       AUTHOR. LEGACY-SYSTEMS.
       DATE-WRITTEN. 2020-01-15.
       
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           C01 IS CONTROL.
       
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT LOAN-FILE ASSIGN TO "LOANDATA.DAT"
                  ORGANIZATION IS SEQUENTIAL
                  ACCESS MODE IS SEQUENTIAL.
       
       DATA DIVISION.
       FILE SECTION.
       FD LOAN-FILE.
       01 LOAN-RECORD.
           05 LOAN-ID              PIC 9(5).
           05 BORROWER-NAME        PIC X(30).
           05 PRINCIPAL-AMOUNT    PIC 9(7)V99.
           05 INTEREST-RATE         PIC V999.
           05 LOAN-TERM-MONTHS    PIC 9(3).
           05 GRACE-PERIOD-DAYS    PIC 9(3).
           05 MONTHLY-PAYMENT      PIC 9(7)V99.
           05 TOTAL-INTEREST       PIC 9(7)V99.
           05 LATE-FEE-APPLIED    PIC X.
           05 LOAN-STATUS         PIC X.
       
       WORKING-STORAGE SECTION.
       01 WS-CALC-TEMP-01       PIC 9(7)V99.
       01 WS-CALC-TEMP-02       PIC 9(7)V99.
       01 WS-CALC-TEMP-03       PIC 9(7)V99.
       01 WS-MONTHLY-RATE       PIC V999.
       01 WS-DAYS-GRACE         PIC 9(3).
       01 WS-TOTAL-PAYMENTS     PIC 9(7)V99.
       01 WS-LOOPS-COUNTER      PIC 9(3).
       01 WS-EOF-FLAG          PIC X VALUE "N".
       01 WS-CURRENT-DATE       PIC 9(8).
       01 WS-LOAN-START-DATE    PIC 9(8).
       01 WS-DAYS-SINCE-START  PIC 9(5).
       01 WS-LATE-FEE-RATE      PIC V999 VALUE 0.05.
       01 WS-LATE-FEE-AMOUNT   PIC 9(7)V99.
       
       PROCEDURE DIVISION.
       MAIN-PROCEDURE.
           PERFORM INITIALIZATION
           PERFORM PROCESS-LOANS
               UNTIL WS-EOF-FLAG = "Y"
           PERFORM FINALIZATION
           STOP RUN.
       
       INITIALIZATION.
           OPEN INPUT LOAN-FILE
           MOVE ZEROS TO WS-TOTAL-PAYMENTS
           MOVE 1 TO WS-LOOPS-COUNTER
           ACCEPT WS-CURRENT-DATE FROM DATE YYYYMMDD.
       
       PROCESS-LOANS.
           READ LOAN-FILE AT END
               MOVE "Y" TO WS-EOF-FLAG
               GO TO PROCESS-LOANS-EXIT
           NOT AT END
               PERFORM CALCULATE-LOAN-DETAILS
               PERFORM DISPLAY-RESULTS
               ADD 1 TO WS-LOOPS-COUNTER
           END-READ.
       PROCESS-LOANS-EXIT.
           EXIT.
       
       CALCULATE-LOAN-DETAILS.
           PERFORM CALCULATE-MONTHLY-INTEREST
           PERFORM CALCULATE-GRACE-PERIOD
           PERFORM CHECK-LATE-FEE
           PERFORM CALCULATE-TOTAL-INTEREST.
       
       CALCULATE-MONTHLY-INTEREST.
           COMPUTE WS-MONTHLY-RATE = 
               INTEREST-RATE / 12
           COMPUTE MONTHLY-PAYMENT = 
               PRINCIPAL-AMOUNT * WS-MONTHLY-RATE / 
               (1 - (1 + WS-MONTHLY-RATE) ** (-LOAN-TERM-MONTHS)).
       
       CALCULATE-GRACE-PERIOD.
           MOVE GRACE-PERIOD-DAYS TO WS-DAYS-GRACE
           IF WS-DAYS-GRACE > 30
               MOVE 30 TO WS-DAYS-GRACE.
       
       CHECK-LATE-FEE.
           PERFORM CALCULATE-DAYS-SINCE-START
           IF WS-DAYS-SINCE-START > WS-DAYS-GRACE
               MOVE "Y" TO LATE-FEE-APPLIED
               PERFORM CALCULATE-LATE-FEE
           ELSE
               MOVE "N" TO LATE-FEE-APPLIED.
       
       CALCULATE-DAYS-SINCE-START.
           MOVE LOAN-ID TO WS-LOAN-START-DATE
           COMPUTE WS-DAYS-SINCE-START = 
               WS-CURRENT-DATE - WS-LOAN-START-DATE.
       
       CALCULATE-LATE-FEE.
           COMPUTE WS-LATE-FEE-AMOUNT = 
               PRINCIPAL-AMOUNT * WS-LATE-FEE-RATE.
       
       CALCULATE-TOTAL-INTEREST.
           COMPUTE WS-CALC-TEMP-01 = 
               MONTHLY-PAYMENT * LOAN-TERM-MONTHS
           COMPUTE WS-CALC-TEMP-02 = 
               WS-CALC-TEMP-01 - PRINCIPAL-AMOUNT
           COMPUTE TOTAL-INTEREST = 
               WS-CALC-TEMP-02 + WS-LATE-FEE-AMOUNT.
       
       DISPLAY-RESULTS.
           DISPLAY "LOAN PROCESSING RESULTS:"
           DISPLAY "LOAN ID: " LOAN-ID
           DISPLAY "BORROWER: " BORROWER-NAME
           DISPLAY "PRINCIPAL: $" PRINCIPAL-AMOUNT
           DISPLAY "MONTHLY PAYMENT: $" MONTHLY-PAYMENT
           DISPLAY "TOTAL INTEREST: $" TOTAL-INTEREST
           DISPLAY "LATE FEE APPLIED: " LATE-FEE-APPLIED
           IF LATE-FEE-APPLIED = "Y"
               DISPLAY "LATE FEE AMOUNT: $" WS-LATE-FEE-AMOUNT
           DISPLAY "LOAN STATUS: " LOAN-STATUS
           DISPLAY "----------------------------------------".
       
       FINALIZATION.
           CLOSE LOAN-FILE
           DISPLAY "PROCESSING COMPLETE. "
           DISPLAY "TOTAL LOANS PROCESSED: " WS-LOOPS-COUNTER
           DISPLAY "TOTAL INTEREST COLLECTED: $" WS-TOTAL-PAYMENTS.
